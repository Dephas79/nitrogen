.PHONY: fix-slim-release test

all: compile nitrogen_js_css

REBAR?=./rebar3

cookie:
	@echo Generating a default cookie in /etc/vm.args
	@(echo -setcookie `openssl rand -base64 50 | head -n1 | sed -e 's/[^a-zA-Z0-9]//g'` >> etc/vm.args)

compile:
	@($(REBAR) compile)

eunit:
	@($(REBAR) eunit)

release:
	./make_version_file.escript go && \
	etc/assemble_config.escript etc etc/autogenerated.config.all && \
	@($(REBAR) release) && \
	make finish_version

revert_version:
	./make_version_file.escript revert

finish_version:
	./make_version_file.escript finish

upgrade_running:
	./make_version_file.escript go && \
	./upgrade_release.sh && \
	make finish_version

run_release: release
	@($(REBAR) run)

run_dev:
	@($(REBAR) shell)
	
upgrade_deps:
	@($(REBAR) upgrade)

nitrogen_js_css: priv/static/nitrogen

copy-static:
	@(escript copy_static.escript copy)

link-static:
	@(escript copy_static.escript link)

plugins:
	@(escript do-plugins.escript)

rebar2_links: site site/static site/src site/templates site/include

site:
	@echo Making Nitrogen 2 compatible directory structure symlinks
	@(mkdir -p site)

site/static:
	@(ln -s ../priv/static site/static)

site/src:
	@(ln -s ../src site/src)

site/templates:
	@(ln -s ../priv/templates site/templates)

site/include:
	@(ln -s ../include site/include)

priv/static/nitrogen: link-static

dialyzer:
	@($(REBAR) dialyzer)

dev:
	mkdir -p _checkouts
	git clone git://github.com/nitrogen/nitrogen_core _checkouts/nitrogen_core
	git clone git://github.com/nitrogen/nprocreg_checkouts/nprocreg
	git clone git://github.com/nitrogen/simple_bridge_checkouts/simple_bridge
	git clone git://github.com/nitrogen/rekt _checkouts/rekt
	git clone git://github.com/nitrogen/nitro_cache  _checkouts/nitro_cache
	git clone git://github.com/choptastic/qdate  _checkouts/qdate
	git clone git://github.com/rustyio/sync _checkouts/sync

#update: compile
#	@(echo "*** CONGRATULATIONS ***")
#	@(echo "Your Nitrogen installation has been upgraded.")
#	@(echo "You may need to manually merge any changes that may have been made to")
#	@(echo "configuration files as well as the initialization modules:")
#	@(echo "    src/nitrogen.app.src")
#	@(echo "    src/nitrogen_sup.erl")
#	@(echo "    src/nitrogen_app.erl")
#	@(echo "")
#
#upgrade: update
